<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.53">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sharon Howard">
<meta name="dcterms.date" content="2024-11-05">
<meta name="description" content="Turning data back into natural language with some {glue}">

<title>Making a Directory of Women – BN Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../profile.jpg" rel="icon" type="image/jpeg">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">BN Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../notes/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://beyondnotability.org/"> 
<span class="menu-text">Beyond Notability</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://beyond-notability.wikibase.cloud/wiki/Main_Page"> 
<span class="menu-text">Database</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Beyond-Notability/bn_notes"> <i class="bi bi-github" role="img" aria-label="Github">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#challenges" id="toc-challenges" class="nav-link" data-scroll-target="#challenges">Challenges</a></li>
  <li><a href="#a-test-case-academic-degrees" id="toc-a-test-case-academic-degrees" class="nav-link" data-scroll-target="#a-test-case-academic-degrees">A test case: academic degrees</a></li>
  <li><a href="#glue" id="toc-glue" class="nav-link" data-scroll-target="#glue">Glue</a>
  <ul class="collapse">
  <li><a href="#glue-1" id="toc-glue-1" class="nav-link" data-scroll-target="#glue-1">glue()</a></li>
  <li><a href="#glue_collapse" id="toc-glue_collapse" class="nav-link" data-scroll-target="#glue_collapse">glue_collapse()</a></li>
  <li><a href="#glue_data" id="toc-glue_data" class="nav-link" data-scroll-target="#glue_data">glue_data()</a></li>
  </ul></li>
  <li><a href="#complications" id="toc-complications" class="nav-link" data-scroll-target="#complications">Complications</a>
  <ul class="collapse">
  <li><a href="#missing-data" id="toc-missing-data" class="nav-link" data-scroll-target="#missing-data">missing data</a></li>
  <li><a href="#pesky-articles" id="toc-pesky-articles" class="nav-link" data-scroll-target="#pesky-articles">pesky articles</a></li>
  </ul></li>
  <li><a href="#building-entries" id="toc-building-entries" class="nav-link" data-scroll-target="#building-entries">Building entries</a>
  <ul class="collapse">
  <li><a href="#all-the-women" id="toc-all-the-women" class="nav-link" data-scroll-target="#all-the-women">all the women</a></li>
  <li><a href="#sorting" id="toc-sorting" class="nav-link" data-scroll-target="#sorting">sorting</a></li>
  <li><a href="#beginnings" id="toc-beginnings" class="nav-link" data-scroll-target="#beginnings">beginnings…</a></li>
  <li><a href="#middle-and-endings" id="toc-middle-and-endings" class="nav-link" data-scroll-target="#middle-and-endings">… middle and endings</a></li>
  </ul></li>
  <li><a href="#bringing-it-all-together" id="toc-bringing-it-all-together" class="nav-link" data-scroll-target="#bringing-it-all-together">Bringing it all together</a></li>
  <li><a href="#the-final-output" id="toc-the-final-output" class="nav-link" data-scroll-target="#the-final-output">The final output</a></li>
  <li><a href="#annie-abram-q536-56-statements" id="toc-annie-abram-q536-56-statements" class="nav-link" data-scroll-target="#annie-abram-q536-56-statements">Annie Abram (Q536: 56 statements)</a></li>
  <li><a href="#irene-josephine-churchill-q317-34-statements" id="toc-irene-josephine-churchill-q317-34-statements" class="nav-link" data-scroll-target="#irene-josephine-churchill-q317-34-statements">Irene Josephine Churchill (Q317: 34 statements)</a></li>
  <li><a href="#agnes-conway-horsfield-q916-60-statements" id="toc-agnes-conway-horsfield-q916-60-statements" class="nav-link" data-scroll-target="#agnes-conway-horsfield-q916-60-statements">Agnes Conway Horsfield (Q916: 60 statements)</a></li>
  <li><a href="#kathleen-mary-kenyon-q709-80-statements" id="toc-kathleen-mary-kenyon-q709-80-statements" class="nav-link" data-scroll-target="#kathleen-mary-kenyon-q709-80-statements">Kathleen Mary Kenyon (Q709: 80 statements)</a></li>
  <li><a href="#margaret-e.-c.-stewart-q3989-19-statements" id="toc-margaret-e.-c.-stewart-q3989-19-statements" class="nav-link" data-scroll-target="#margaret-e.-c.-stewart-q3989-19-statements">Margaret E. C. Stewart (Q3989: 19 statements)</a></li>
  <li><a href="#full-code-and-sample-outputs" id="toc-full-code-and-sample-outputs" class="nav-link" data-scroll-target="#full-code-and-sample-outputs">Full code and sample outputs</a></li>
  <li><a href="#see-also" id="toc-see-also" class="nav-link" data-scroll-target="#see-also">See also</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Making a Directory of Women</h1>
  <div class="quarto-categories">
    <div class="quarto-category">methods</div>
  </div>
  </div>

<div>
  <div class="description">
    Turning data back into natural language with some {glue}
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sharon Howard </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">5 November 2024</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">17 December 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> finishing-up </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How do you turn structured data back into more human-reader-friendly narratives? Here I discuss a semi-automated way of doing it, using the R <a href="https://glue.tidyverse.org/index.html">glue</a> package.</p>
<p>Even though it’s quite specific to the project’s data and needs, it was felt that that some documentation of the technical methods and thought processes might be useful for other projects. I’ve posted an example of full code on <a href="https://github.com/Beyond-Notability/bn_r_doc">the BN R code repository</a>; this post is a small demonstration of the process.</p>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>This is a particular kind of use case. It depends on considerable familiarity with the database. Crucially, the input data is already clean, structured and well suited to the task. So there’s no machine learning involved and very few of the tasks would be likely to need it, even if the database were much larger. It’s all fairly straightforward rules-based processing. (Nonetheless, I did find some of the literature on natural language generation helpful for thinking about how to make prose from structured data sources, not least in breaking down the process into its constituent parts, from document content and structure to linguistic structures to word order (eg see Reiter and Dale 1997, Duma and Klein 2013).)</p>
<p>Why would you even want to do this, having gone to all the trouble of creating a structured database? In general, I think it’s important to offer people different ways of accessing complex databases to suit different needs, for example, browsing, keyword searching, more structured searches, and sharing complete datasets.</p>
<p>More specifically, the BN wikibase is very large, complex and detailed, and it’s hard to know where to begin. People need some help to find their way around! So, for example, I made a summary spreadsheet of selected data for project partners at <a href="https://www.sal.org.uk/">the SAL archives</a>.</p>
<p>I was also asked if it would be possible to make a “Directory” of mini-biographies for <em>all</em> the 900 or so women in the BN database, using selected categories of data. This would form an appendix to the project monograph, but also be useful as a standalone resource. It would offer a different way into the data, an introduction to the fuller ranger of information in the wikibase, and perhaps especially so for less “notable” women who don’t already have online biographies elsewhere.</p>
<p>There are older printed models for this. Some of the BN women appeared in the <a href="https://lse-atom.arkivum.net/uklse-dl1pu01002001">LSE Register 1895-1932</a>, which crammed remarkable amounts of brutally abbreviated information about LSE students into its pages. For example:</p>
<blockquote class="blockquote">
<p><a href="https://beyond-notability.wikibase.cloud/wiki/Item:Q536"><strong>ABRAM, Annie</strong></a>; <em>deceased</em> Oct.&nbsp;17, 1930. <em>Educ.</em> Univ. of Cambridge (Hist. Tripos); Univ. of Dublin (B.A.); L.S.E. 1905-9, occ. to 1914; D.Sc. (Econ.) 1909.</p>
</blockquote>
<blockquote class="blockquote">
<p><a href="https://beyond-notability.wikibase.cloud/wiki/Item:Q317"><strong>CHURCHILL, Irene Josephine</strong></a>; <em>b.</em> Dec.&nbsp;18, 1887. <em>Educ.</em> Oakhurst Sch., Shortlands, Kent; Lady Margaret Hall, Oxford (2nd .Cl. Final Hons., Sch. of Mod. Hist., 1910; D.Phil.1930); L.S.E.1910-9, Cert.’ in Hist. 1913. F.R.Hist.S. 1914. War service: Organising Sec., War Hospital Supply Depot, under D.G.V.O. (War Office),1916-9. Assistant to Dr.&nbsp;Claude Jenkins, Lambeth Librarian, Lambeth Palace, Oct.&nbsp;1918-June 1929; Assist. Lambeth Librarian, July 1929 to date. <em>Publications.</em> Handbook to Kent Records (Vol. II, Kent Records), 1915; East Kent Records (Vol. VII, <em>ibid.</em>), 1922; Canterbury Administration (S.P.C.K. for Church Hist. Soc.), 2 Vols. <em>Address.</em> Fircroft, 22 Mays Hill Rd., Shortlands, Kent.</p>
</blockquote>
<p>We don’t need to apply such ruthless compression of information (one of the goals was to produce something slightly more pleasing to read!) but we do have to be highly selective about what to include.</p>
</section>
<section id="challenges" class="level2">
<h2 class="anchored" data-anchor-id="challenges">Challenges</h2>
<ol type="1">
<li>the complexity and variety of the data</li>
</ol>
<p>A few variables in the database - for example, a woman’s birth surname - should have only a single value, but many are likely to have multiple values. Virtually all can have none, which can be equally tricky.</p>
<p>For example, <a href="https://beyond-notability.wikibase.cloud/wiki/Item:Q916">Agnes Conway Horsfield</a> held two academic degrees: a <a href="https://beyond-notability.wikibase.cloud/wiki/Item:Q593">bachelor’s degree</a> <a href="https://beyond-notability.wikibase.cloud/wiki/Property:P61"><code>conferred by</code></a> <a href="https://beyond-notability.wikibase.cloud/wiki/Item:Q625">Trinity College Dublin</a> (date unknown) and a <a href="https://beyond-notability.wikibase.cloud/wiki/Item:Q359">master’s degree</a> <code>conferred by</code> the <a href="https://beyond-notability.wikibase.cloud/wiki/Item:Q154">University of London</a> in 1926.</p>
<p>This is what they look like in the wikibase:</p>
<p><img src="horsfield-degrees.jpg" class="img-fluid"></p>
<ol start="2" type="1">
<li>(re)shaping pieces of structured data into prose sentences</li>
</ol>
<p>The Wikibase Query Service returns that information as rectangular data looking something like this.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 7%">
<col style="width: 24%">
<col style="width: 19%">
<col style="width: 24%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">person</th>
<th style="text-align: center;">personLabel</th>
<th style="text-align: center;">degreeLabel</th>
<th style="text-align: center;">byLabel</th>
<th style="text-align: center;">date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">Q916</td>
<td style="text-align: center;">Agnes Conway Horsfield</td>
<td style="text-align: center;">bachelor’s degree</td>
<td style="text-align: center;">Trinity College Dublin</td>
<td style="text-align: center;">_:t91223</td>
</tr>
<tr class="even">
<td style="text-align: right;">Q916</td>
<td style="text-align: center;">Agnes Conway Horsfield</td>
<td style="text-align: center;">master’s degree</td>
<td style="text-align: center;">University of London</td>
<td style="text-align: center;">1926-01-01T00:00:00Z</td>
</tr>
</tbody>
</table>
<p>And what would I <em>like</em> it to look like?</p>
<blockquote class="blockquote">
<p>Agnes Conway Horsfield was awarded a bachelor’s degree by Trinity College Dublin and a master’s degree by the University of London in 1926.</p>
</blockquote>
<p>To think through some key changes that are needed:</p>
<ul>
<li><strong>restructuring</strong>
<ul>
<li>the two rows of data need to be <em>collapsed</em> into a single sentence,</li>
<li>in which the two degrees form elements of a list with appropriate separators (easy when there are only two elements, but more complicated with more than two)</li>
</ul></li>
<li><strong>dates</strong>
<ul>
<li>the “_:t91223” in the first degree represents a wikibase “unknown value” (a specific data type), so date information needs to be omitted entirely for that element</li>
<li>the <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a> format timestamp needs to be converted to a year</li>
<li>knowing that dates can be absent makes sorting the elements of the list a bit more of a problem; for now I’ll keep the original database order and hope that it always makes sense. (In the full version of the code, I’ve added a custom sort order based on the hierarchy of degree qualifications.)</li>
</ul></li>
<li><strong>connecting words</strong>
<ul>
<li>verbs</li>
<li>prepositions</li>
<li>articles (indefinite, definite, none)</li>
</ul></li>
</ul>
</section>
<section id="a-test-case-academic-degrees" class="level2">
<h2 class="anchored" data-anchor-id="a-test-case-academic-degrees">A test case: academic degrees</h2>
<p>I’ll make a small sample of five women and their academic degrees for testing: Annie Abram, Irene Churchill, Agnes Horsfield, <a href="https://beyond-notability.wikibase.cloud/wiki/Item:Q3989">Margaret E.C. Stewart</a> and <a href="https://beyond-notability.wikibase.cloud/wiki/Item:Q709">Kathleen Mary Kenyon</a>. Between them they held ten academic degrees, including undergraduate and postgraduate degrees, from four different institutions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## load shared libraries, functions etc</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_R/shared.R"</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_R/std_queries.R"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>[See <a href="https://beyond-notability.github.io/bn_notes/notes/workflow.html">my post on workflows</a> for background on the general methods for fetching data from the wikibase for processing and analysis.]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## fetch degrees for the sample</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>degrees_sparql <span class="ot">&lt;-</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">'SELECT distinct ?person ?personLabel ?degreeLabel ?byLabel ?date ?by</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE {</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">  VALUES ?person {bnwd:Q916 bnwd:Q709 bnwd:Q536 bnwd:Q317 bnwd:Q3989}</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">   ?person bnp:P59 ?s.</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="st">      ?s bnps:P59 ?degree .</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="st">      optional { ?s bnpq:P61 ?by . }</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="st">      optional { ?s bnpq:P1 ?date . }</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="st">  SERVICE wikibase:label { </span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="st">    bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en,en-gb". </span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="ot">&lt;-</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bn_std_query</span>(degrees_sparql) <span class="sc">|&gt;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_bn_ids</span>(<span class="fu">c</span>(person, by)) <span class="sc">|&gt;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(date, byLabel), <span class="sc">~</span><span class="fu">na_if</span>(., <span class="st">""</span>))) <span class="sc">|&gt;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_date_year</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>date) <span class="sc">|&gt;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(degreeLabel <span class="sc">!=</span><span class="st">"Certificate"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(personLabel, year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>by) <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">person</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">personLabel</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">degreeLabel</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">byLabel</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">year</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Q916</td>
<td style="text-align: left;">Agnes Conway Horsfield</td>
<td style="text-align: left;">bachelor's degree</td>
<td style="text-align: left;">Trinity College Dublin</td>
<td style="text-align: right;">1907</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q916</td>
<td style="text-align: left;">Agnes Conway Horsfield</td>
<td style="text-align: left;">master's degree</td>
<td style="text-align: left;">University of London</td>
<td style="text-align: right;">1926</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q536</td>
<td style="text-align: left;">Annie Abram</td>
<td style="text-align: left;">bachelor's degree</td>
<td style="text-align: left;">Trinity College Dublin</td>
<td style="text-align: right;">1906</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q536</td>
<td style="text-align: left;">Annie Abram</td>
<td style="text-align: left;">doctor of science</td>
<td style="text-align: left;">University of London</td>
<td style="text-align: right;">1909</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q317</td>
<td style="text-align: left;">Irene Josephine Churchill</td>
<td style="text-align: left;">doctor of philosophy</td>
<td style="text-align: left;">University of Oxford</td>
<td style="text-align: right;">1930</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q709</td>
<td style="text-align: left;">Kathleen Mary Kenyon</td>
<td style="text-align: left;">bachelor's degree</td>
<td style="text-align: left;">University of Oxford</td>
<td style="text-align: right;">1928</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q709</td>
<td style="text-align: left;">Kathleen Mary Kenyon</td>
<td style="text-align: left;">master's degree</td>
<td style="text-align: left;">University of Oxford</td>
<td style="text-align: right;">1933</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q709</td>
<td style="text-align: left;">Kathleen Mary Kenyon</td>
<td style="text-align: left;">Doctor of Letters</td>
<td style="text-align: left;">University of London</td>
<td style="text-align: right;">1954</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q3989</td>
<td style="text-align: left;">Margaret E. C. Stewart</td>
<td style="text-align: left;">master's degree</td>
<td style="text-align: left;">University of Edinburgh</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q3989</td>
<td style="text-align: left;">Margaret E. C. Stewart</td>
<td style="text-align: left;">doctor of philosophy</td>
<td style="text-align: left;">University of Edinburgh</td>
<td style="text-align: right;">NA</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="glue" class="level2">
<h2 class="anchored" data-anchor-id="glue">Glue</h2>
<p>What does the <a href="https://glue.tidyverse.org/index.html">glue</a> package do?</p>
<blockquote class="blockquote">
<p>Glue offers interpreted <a href="https://en.wikipedia.org/wiki/String_literal">string literals</a> that are small, fast, and dependency-free. Glue does this by embedding R expressions in curly braces which are then evaluated and inserted into the argument string.</p>
</blockquote>
<p>I’m using three key functions: <code>glue()</code>, <code>glue_collapse()</code> and <code>glue_data()</code>.</p>
<section id="glue-1" class="level3">
<h3 class="anchored" data-anchor-id="glue-1">glue()</h3>
<p>First, <code>glue()</code> makes it trivially easy to insert bits of data from a dataframe into a text template. It works well in a dplyr pipeline with mutate().</p>
<p>Data is simply inserted into a text string using {curly braces} (if you need curly braces in the text you can escape them by doubling up {{…}} or you can even tell glue to use a different symbol).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sentence =</span> <span class="fu">glue</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"{personLabel} was awarded a {degreeLabel} by {byLabel}."</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sentence) <span class="sc">|&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">sentence</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Agnes Conway Horsfield was awarded a bachelor's degree by Trinity College Dublin.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Agnes Conway Horsfield was awarded a master's degree by University of London.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Annie Abram was awarded a bachelor's degree by Trinity College Dublin.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Annie Abram was awarded a doctor of science by University of London.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Irene Josephine Churchill was awarded a doctor of philosophy by University of Oxford.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kathleen Mary Kenyon was awarded a bachelor's degree by University of Oxford.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Kathleen Mary Kenyon was awarded a master's degree by University of Oxford.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kathleen Mary Kenyon was awarded a Doctor of Letters by University of London.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Margaret E. C. Stewart was awarded a master's degree by University of Edinburgh.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Margaret E. C. Stewart was awarded a doctor of philosophy by University of Edinburgh.</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>In practice, I’ll be splitting sentences up into segments that have separate processing; glue can happily combine different bits of data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>degree_verb <span class="ot">&lt;-</span> <span class="st">"was awarded"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="st">"a"</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">glue_by =</span> <span class="fu">glue</span>(<span class="st">"by {byLabel}"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sentence =</span> <span class="fu">glue</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"{personLabel}"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"{degree_verb}"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"{a}"</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"{degreeLabel}"</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"{glue_by}."</span>, </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.sep =</span> <span class="st">" "</span>  </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sentence) <span class="sc">|&gt;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">sentence</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Agnes Conway Horsfield was awarded a bachelor's degree by Trinity College Dublin.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Agnes Conway Horsfield was awarded a master's degree by University of London.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Annie Abram was awarded a bachelor's degree by Trinity College Dublin.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Annie Abram was awarded a doctor of science by University of London.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Irene Josephine Churchill was awarded a doctor of philosophy by University of Oxford.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kathleen Mary Kenyon was awarded a bachelor's degree by University of Oxford.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Kathleen Mary Kenyon was awarded a master's degree by University of Oxford.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kathleen Mary Kenyon was awarded a Doctor of Letters by University of London.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Margaret E. C. Stewart was awarded a master's degree by University of Edinburgh.</td>
</tr>
<tr class="even">
<td style="text-align: left;">Margaret E. C. Stewart was awarded a doctor of philosophy by University of Edinburgh.</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="glue_collapse" class="level3">
<h3 class="anchored" data-anchor-id="glue_collapse">glue_collapse()</h3>
<p>Next, <code>glue_collapse()</code> is used to collapse multiple items of data for a person into single statements (in combination with dplyr’s <code>group_by()</code> and <code>summarise()</code> functions). Note how the function can handle the last two elements of a list separately from the rest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(personLabel) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">degrees_collapse =</span> <span class="fu">glue_collapse</span>(degreeLabel, <span class="at">sep=</span><span class="st">", "</span>, <span class="at">last =</span> <span class="st">" and "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">personLabel</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">degrees_collapse</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Agnes Conway Horsfield</td>
<td style="text-align: left;">bachelor's degree and master's degree</td>
</tr>
<tr class="even">
<td style="text-align: left;">Annie Abram</td>
<td style="text-align: left;">bachelor's degree and doctor of science</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Irene Josephine Churchill</td>
<td style="text-align: left;">doctor of philosophy</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kathleen Mary Kenyon</td>
<td style="text-align: left;">bachelor's degree, master's degree and Doctor of Letters</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Margaret E. C. Stewart</td>
<td style="text-align: left;">master's degree and doctor of philosophy</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><code>glue_collapse()</code> can also handle <em>NA</em> (<a href="https://rdrr.io/r/base/NA.html">R’s symbol for missing data</a>; when using R it’s important to know that <em>NA</em> is different from a blank field).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(personLabel) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># na.omit() deals with mixed *NA* and values</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">year_collapse =</span> <span class="fu">glue_collapse</span>(<span class="fu">na.omit</span>(year), <span class="at">sep=</span><span class="st">", "</span>, <span class="at">last =</span> <span class="st">" and "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">personLabel</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">year_collapse</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Agnes Conway Horsfield</td>
<td style="text-align: left;">1907 and 1926</td>
</tr>
<tr class="even">
<td style="text-align: left;">Annie Abram</td>
<td style="text-align: left;">1906 and 1909</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Irene Josephine Churchill</td>
<td style="text-align: left;">1930</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kathleen Mary Kenyon</td>
<td style="text-align: left;">1928, 1933 and 1954</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Margaret E. C. Stewart</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="glue_data" class="level3">
<h3 class="anchored" data-anchor-id="glue_data">glue_data()</h3>
<p>At the very end of the pipeline <code>glue_data()</code> is convenient for printing out the sentences.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(personLabel) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">degrees_collapse =</span> <span class="fu">glue_collapse</span>(degreeLabel, <span class="at">sep=</span><span class="st">", "</span>, <span class="at">last =</span> <span class="st">" and "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glue_data</span>(<span class="st">"{personLabel} {degree_verb} a {degrees_collapse}."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Agnes Conway Horsfield was awarded a bachelor's degree and master's degree.
Annie Abram was awarded a bachelor's degree and doctor of science.
Irene Josephine Churchill was awarded a doctor of philosophy.
Kathleen Mary Kenyon was awarded a bachelor's degree, master's degree and Doctor of Letters.
Margaret E. C. Stewart was awarded a master's degree and doctor of philosophy.</code></pre>
</div>
</div>
</section>
</section>
<section id="complications" class="level2">
<h2 class="anchored" data-anchor-id="complications">Complications</h2>
<p>So those are the basic principles. But the transition from data to natural language, even the simple sentences I want here, isn’t quite so easy.</p>
<section id="missing-data" class="level3">
<h3 class="anchored" data-anchor-id="missing-data">missing data</h3>
<p>Unlike <code>glue_collapse()</code>, <code>glue()</code> can’t fix missing data on its own; it’ll print <em>NA</em> as a string “NA”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">degree_info =</span> <span class="fu">glue</span>(<span class="st">"by {byLabel} in {year}."</span>)) <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(degree_info) <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">degree_info</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">by Trinity College Dublin in 1907.</td>
</tr>
<tr class="even">
<td style="text-align: left;">by University of London in 1926.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">by Trinity College Dublin in 1906.</td>
</tr>
<tr class="even">
<td style="text-align: left;">by University of London in 1909.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">by University of Oxford in 1930.</td>
</tr>
<tr class="even">
<td style="text-align: left;">by University of Oxford in 1928.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">by University of Oxford in 1933.</td>
</tr>
<tr class="even">
<td style="text-align: left;">by University of London in 1954.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">by University of Edinburgh in NA.</td>
</tr>
<tr class="even">
<td style="text-align: left;">by University of Edinburgh in NA.</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>And in any case, it isn’t just a matter of dropping the year; the connecting “in” also has to be omitted. (The same thing applies in cases where we don’t know the conferring institution; only the degree label is certain to be present.)</p>
<p>For me, this is most easily handled with a conditional function (<code>if_else()</code> or <code>case_when()</code> for something more than a simple either/or): <em>if</em> the value isn’t <em>NA</em>, use the glue statement, <em>else</em> make it a blank (““).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">glue_year =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(year), <span class="fu">glue</span>(<span class="st">"in {year}"</span>), <span class="st">""</span>)) <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(person, glue_year) <span class="sc">|&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">person</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">glue_year</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Q916</td>
<td style="text-align: left;">in 1907</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q916</td>
<td style="text-align: left;">in 1926</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q536</td>
<td style="text-align: left;">in 1906</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q536</td>
<td style="text-align: left;">in 1909</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q317</td>
<td style="text-align: left;">in 1930</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q709</td>
<td style="text-align: left;">in 1928</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q709</td>
<td style="text-align: left;">in 1933</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q709</td>
<td style="text-align: left;">in 1954</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q3989</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Q3989</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>


</div>
</div>
<p>I’ll need this several times, so it makes sense to convert that specific if/else instruction into a more general function which can be used with different prefixes, enabling a more modular approach. The before, between and after arguments allow for adjustment of space (default is to add a space before and in the middle but none after, because that’s what worked best for me here).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## prefix x with a word/phrase, or make the string "" if NA. </span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="do">## to be used inside a mutate()</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>prefix_na <span class="ot">&lt;-</span> <span class="cf">function</span>(x, prefix, <span class="at">before=</span><span class="st">" "</span>, <span class="at">between=</span><span class="st">" "</span>, <span class="at">after=</span><span class="st">""</span>){</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(x),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(<span class="st">"{before}{prefix}{between}{x}{after}"</span>), </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">""</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">glue_by =</span> <span class="fu">prefix_na</span>(byLabel, <span class="st">"by"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">glue_year =</span> <span class="fu">prefix_na</span>(year, <span class="st">"in"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glue_data</span>(<span class="st">"{personLabel} {degree_verb} a {degreeLabel}{glue_by}{glue_year}."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Agnes Conway Horsfield was awarded a bachelor's degree by Trinity College Dublin in 1907.
Agnes Conway Horsfield was awarded a master's degree by University of London in 1926.
Annie Abram was awarded a bachelor's degree by Trinity College Dublin in 1906.
Annie Abram was awarded a doctor of science by University of London in 1909.
Irene Josephine Churchill was awarded a doctor of philosophy by University of Oxford in 1930.
Kathleen Mary Kenyon was awarded a bachelor's degree by University of Oxford in 1928.
Kathleen Mary Kenyon was awarded a master's degree by University of Oxford in 1933.
Kathleen Mary Kenyon was awarded a Doctor of Letters by University of London in 1954.
Margaret E. C. Stewart was awarded a master's degree by University of Edinburgh.
Margaret E. C. Stewart was awarded a doctor of philosophy by University of Edinburgh.</code></pre>
</div>
</div>
</section>
<section id="pesky-articles" class="level3">
<h3 class="anchored" data-anchor-id="pesky-articles">pesky articles</h3>
<p>Generally, item labels in the wikibase do not include definite or indefinite <a href="https://en.wikipedia.org/wiki/Article_(grammar)">articles</a>, which is perfectly proper and sensible in a database context. But it doesn’t work so well when they need to be inserted in prose sentences. There are two main sources of variation that cause problems:</p>
<ul>
<li>there are two choices of indefinite article, “a” or “an”, depending on whether the item label starts with a vowel.</li>
<li>there are also two choices of definite article: some names (eg “Somerville College”) use <a href="https://en.wikipedia.org/wiki/Zero-marking_in_English#Zero_article">the zero article</a></li>
<li>also, occasionally an item label <em>does</em> already have a definite article</li>
</ul>
<p>In the case of indefinite articles for the degree labels, both the choice of a/an and the possibility of a/an already being present can be covered with a bit of regex.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>prefix_an <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">case_when</span>(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if the string x already starts with the word a/an, don't prefix anything</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(x, <span class="st">"^an?</span><span class="sc">\b</span><span class="st">"</span>) <span class="sc">~</span> <span class="fu">glue</span>(<span class="st">"{x}"</span>),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if it starts with a vowel, prefix with "an"; </span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(x, <span class="st">"^[AEIOUaeiou]"</span>) <span class="sc">~</span> <span class="fu">glue</span>(<span class="st">"an {x}"</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># otherwise - as long as it's not *NA* - prefix with "a"; </span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fu">glue</span>(<span class="st">"a {x}"</span>),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># keep anything left behind (should only be NAs) as it is</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> x</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Meanwhile, there are variable conventions in definite article usage for institution names in English. For example:</p>
<ul>
<li>“the University of Oxford” but <em>not</em> “the Manchester University”</li>
<li>“the Courtauld Institute” but <em>not</em> “the Somerville College”</li>
<li>“the University College of North Wales” but <em>not</em> “the University College London”</li>
</ul>
<p><em>I’m</em> not sure how I know these differences, so a computer certainly isn’t going to be able to work them out without some help. If this were a much larger database, I might be thinking about machine learning methods (it could be an opportunity to try out <a href="https://programminghistorian.org/en/lessons/understanding-creating-word-embeddings">word embeddings</a>). But there are less than 200 different higher education organisations in the database, almost all of which can be covered by three rules, so it’s easier to create a rules-based list.</p>
<p>Whatever method I might ultimately use, it’s helpful to do some modelling to understand something about what the patterns are likely to be in in my data. There are other types of organisation in the database where the conventions are different from (and, well, more conventional than) those of universities and colleges. Learned societies, for example, almost always take the definite article. Commercial organisations could be quite different again.</p>
<p>In this case, I already have a resource within the database that will cover many of the names. I’ve already worked out that names like “Placename University” or “Placename College” use the zero article, and the BN database contains more than 1000 items categorised as places. So I can reuse those. That handles about half the organisations; “the University/College/whatever of X” (definite) and “Name College” (zero) will deal with almost all the rest.</p>
<p>(There are also a few non-English institutions in the database which may want separate treatment - if the text is in English, should it be “La Sorbonne” or “The Sorbonne”? I’m lazy so I’ll take the easier route for now.)</p>
<p>This will want another little function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># if the `category` is "the" use as prefix; otherwise leave as it is. </span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># can be adapted further if necessary.</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>definite_org <span class="ot">&lt;-</span> <span class="cf">function</span>(x, category){</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">case_when</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    category<span class="sc">==</span><span class="st">"zero"</span> <span class="sc">~</span> x,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    category<span class="sc">==</span><span class="st">"the"</span> <span class="sc">~</span> <span class="fu">prefix_na</span>(x, category, <span class="at">before =</span> <span class="st">""</span>),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> x</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, get all the items in the wikibase that have <code>instance of</code> “locality”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>location_sparql <span class="ot">&lt;-</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="st">'SELECT distinct ?locationLabel ?location   </span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE {  </span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="st">  ?location bnwdt:P12 bnwd:Q2147 . # i/o locality</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="st">  SERVICE wikibase:label { </span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="st">    bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en,en-gb". </span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="st">    } </span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>location_query <span class="ot">&lt;-</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bn_std_query</span>(location_sparql) <span class="sc">|&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_bn_ids</span>(location) <span class="sc">|&gt;</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(locationLabel)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>location_rgx <span class="ot">&lt;-</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>location_query <span class="sc">|&gt;</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out a few generics that start [a-z]</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(locationLabel, <span class="st">"^[A-Z]"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove some unwanted stuff and then make unique</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">locationLabel =</span> <span class="fu">str_trim</span>(<span class="fu">str_remove</span>(locationLabel, <span class="st">" *</span><span class="sc">\\</span><span class="st">((district|village|borough|parish|area|county|unitary authority|civil parish|community|region|settlement|city|council area)</span><span class="sc">\\</span><span class="st">)"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(locationLabel) <span class="sc">|&gt;</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># turn them into a regex with a | separator</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">rgx =</span> <span class="fu">glue_collapse</span>(locationLabel, <span class="at">sep=</span><span class="st">"|"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># final regex: </span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># must be at the beginning of the name </span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># \\b at the end to avoid scunthorpes</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add a few placenames that didn't turn up in the database</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rgx =</span> <span class="fu">glue</span>(<span class="st">"^({rgx}|Chelsea|Clapham|Edmonton|Hampton Court|Harpenden|Harrow|Sheringham|South Kensington|South Tottenham|Welwyn Garden City|Whitechapel|New Cross|North Hackney|Regent Street|Victoria)</span><span class="sc">\\</span><span class="st">b"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then get all the <code>instance of</code> “higher education institution”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fetch items that are higher education institutions.</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>hei_sparql <span class="ot">&lt;-</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="st">'SELECT distinct ?item ?itemLabel  </span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE {</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="st">    ?item bnwdt:P12 bnwd:Q2914 .</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="st"> SERVICE wikibase:label { </span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="st">    bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en,en-gb". </span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="st">    } </span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="st">} # /where</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="st">ORDER BY ?itemLabel'</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>hei_query <span class="ot">&lt;-</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bn_std_query</span>(hei_sparql) <span class="sc">|&gt;</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_bn_ids</span>(item)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use the rules I’ve worked out to categorise the names as “the” or “zero”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>hei <span class="ot">&lt;-</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  hei_query <span class="sc">|&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out a couple of non-specific items</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>item <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Q2485"</span>, <span class="st">"Q2916"</span>) ) <span class="sc">|&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># categorise as "zero" or "the"</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">the_label =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># London is a pain. </span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(itemLabel, <span class="st">"^London (Society for|School of)"</span>) <span class="sc">~</span> <span class="st">"the"</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># otherwise, if it starts with a placename = zero</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(itemLabel, location_rgx<span class="sc">$</span>rgx) <span class="sc">~</span> <span class="st">"zero"</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "University etc of" = the.</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(itemLabel, <span class="st">"(University|University College|Royal College|School|Institute) of"</span>) <span class="sc">~</span> <span class="st">"the"</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># anything else that's (Something) College = zero</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(itemLabel, <span class="st">"College"</span>) <span class="sc">~</span> <span class="st">"zero"</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># nearly all the rest = the; this deals with a few exceptions</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(itemLabel, <span class="st">"Greenway Court|Harvard University|^Lady</span><span class="sc">\\</span><span class="st">b"</span>) <span class="sc">~</span> <span class="st">"zero"</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># everything else</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> <span class="st">"the"</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">the_label =</span> <span class="fu">definite_org</span>(itemLabel, the_label)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A quick look at the first 10 rows seems good.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hei, <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>item) <span class="sc">|&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">itemLabel</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">the_label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Abergavenny extension centre</td>
<td style="text-align: left;">Abergavenny extension centre</td>
</tr>
<tr class="even">
<td style="text-align: left;">American School of Classical Studies at Athens</td>
<td style="text-align: left;">the American School of Classical Studies at Athens</td>
</tr>
<tr class="odd">
<td style="text-align: left;">American School of Prehistoric Research</td>
<td style="text-align: left;">the American School of Prehistoric Research</td>
</tr>
<tr class="even">
<td style="text-align: left;">American University of Beirut</td>
<td style="text-align: left;">the American University of Beirut</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Architectural Association</td>
<td style="text-align: left;">the Architectural Association</td>
</tr>
<tr class="even">
<td style="text-align: left;">Armstrong College</td>
<td style="text-align: left;">Armstrong College</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Barnard College</td>
<td style="text-align: left;">Barnard College</td>
</tr>
<tr class="even">
<td style="text-align: left;">Barnet Extension Centre</td>
<td style="text-align: left;">Barnet Extension Centre</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Barnsley extension centre</td>
<td style="text-align: left;">Barnsley extension centre</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bedford College</td>
<td style="text-align: left;">Bedford College</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>So at last…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the augmented labels </span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(hei <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">by=</span>item, the_label), <span class="at">by=</span><span class="st">"by"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use the_label instead of the original</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">glue_by =</span> <span class="fu">prefix_na</span>(the_label, <span class="st">"by"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">glue_year =</span> <span class="fu">prefix_na</span>(year, <span class="st">"in"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">glue_degree =</span> <span class="fu">glue</span>(<span class="st">"a {degreeLabel}{glue_by}{glue_year}"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(personLabel) <span class="sc">|&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">degree_collapse =</span> </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">glue_collapse</span>(glue_degree, <span class="st">", "</span>, <span class="at">last =</span> <span class="st">" and "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glue_data</span>(<span class="st">"{personLabel} was awarded {degree_collapse}."</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Agnes Conway Horsfield was awarded a bachelor's degree by Trinity College Dublin in 1907 and a master's degree by the University of London in 1926.
Annie Abram was awarded a bachelor's degree by Trinity College Dublin in 1906 and a doctor of science by the University of London in 1909.
Irene Josephine Churchill was awarded a doctor of philosophy by the University of Oxford in 1930.
Kathleen Mary Kenyon was awarded a bachelor's degree by the University of Oxford in 1928, a master's degree by the University of Oxford in 1933 and a Doctor of Letters by the University of London in 1954.
Margaret E. C. Stewart was awarded a master's degree by the University of Edinburgh and a doctor of philosophy by the University of Edinburgh.</code></pre>
</div>
</div>
</section>
</section>
<section id="building-entries" class="level2">
<h2 class="anchored" data-anchor-id="building-entries">Building entries</h2>
<p>[Some of the code in this section is not shown in full; see <a href="https://github.com/Beyond-Notability/bn_r_doc">BN R Documentation Github repository</a> for an example of the full code.]</p>
<section id="all-the-women" class="level3">
<h3 class="anchored" data-anchor-id="all-the-women">all the women</h3>
<p>I want a “starter” list of every woman in the wikibase. This will, among other things, help to create a standard header for each woman.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="do">## get a list of all the women in the wikibase</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="do">## with number of statements</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>bn_starter_list_sparql <span class="ot">&lt;-</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">'SELECT distinct ?person ?personLabel ?statements</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE {</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="st">   ?person bnwdt:P3 bnwd:Q3 ; # women</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="st">         wikibase:statements ?statements . </span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="st">   FILTER NOT EXISTS {?person bnwdt:P4 bnwd:Q12 .}</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="st">   SERVICE wikibase:label { </span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="st">      bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en,en-gb". </span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="st">      } </span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>bn_starter_list_query <span class="ot">&lt;-</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bn_std_query</span>(bn_starter_list_sparql) <span class="sc">|&gt;</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_bn_ids</span>(person) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sorting" class="level3">
<h3 class="anchored" data-anchor-id="sorting">sorting</h3>
<p>I also need to get people sorted in the right order (alphabetically by surname-firstname). This is a little bit tricky because names are not recorded in the format “surname, firstname(s)” anywhere in the wikibase. Women can have quite complex and varied names (titles, middle names, multiple surnames, etc) so that I can’t simply assume the last word in the name will serve for sorting.</p>
<p>Fortunately, there is information about married and birth surnames for a lot of people, which can also be used to include alternative names (“a.k.a.” or “née”) for women who changed their names.</p>
<p>A note: which surname to sort by, if there’s a choice?</p>
<p>The project adopted a contextualised approach to wikibase name labels; so, for example, <a href="https://beyond-notability.wikibase.cloud/wiki/Item:Q106">Jacquetta Hawkes</a>, is <em>not</em> recorded as “Jacquetta Priestley” merely because that was her last husband’s surname. But for sorting purposes I do need to apply some standard rules, so I may not be able to guarantee that the ordering will always reflect the project’s preferences. (All the more reason to include alternative names where possible.)</p>
</section>
<section id="beginnings" class="level3">
<h3 class="anchored" data-anchor-id="beginnings">beginnings…</h3>
<p>Each entry will need a heading which includes:</p>
<ul>
<li>her full name as recorded in the wikibase</li>
<li>item number in the wikibase (beginning with “Q”)</li>
<li>number of “statements” she has in the wikibase</li>
</ul>
<blockquote class="blockquote">
<p>Annie Abram (Q536: 48 statements)</p>
</blockquote>
<p>Both the name and Q number should facilitate looking someone up in the wikibase; the statements number is a quick way to give a sense of how much information we have about her.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>bn_heading <span class="ot">&lt;-</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>bn_names_list <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name_id_statements =</span> <span class="fu">glue</span>(<span class="st">"{personLabel} ({person}: {statements} statements)</span><span class="sc">\n</span><span class="st">"</span>))  <span class="sc">|&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name_id_statements, person) <span class="sc">|&gt;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">order=</span><span class="dv">0</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After the heading, I want a standard introductory sentence for every woman. If we know when a woman was born, the obvious thing to do is start with that information. But we often don’t have it, so alternatives are needed. This went three ways in the end:</p>
<ul>
<li>if we have a date of birth: “{personLabel} was born in {year}.”</li>
<li>if we don’t have a date of birth but do have at least one other kind of date: “{personLabel}’s earliest appearance in BN is dated {year}.”</li>
<li>a fallback if we don’t have any dates for a person (since it’s a sure bet we know very little about them): “Beyond Notability has recorded little information about {personLabel}.”</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>bn_first_sentence <span class="ot">&lt;-</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>bn_dates <span class="sc">|&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">statement =</span> <span class="fu">case_when</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(year_birth) <span class="sc">~</span> <span class="fu">glue</span>(<span class="st">"{personLabel} was born in {year_birth}."</span>),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(earliest) <span class="sc">~</span> <span class="fu">glue</span>(<span class="st">"{personLabel}'s earliest appearance in Beyond Notability's records is dated {earliest}."</span>),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.default =</span> <span class="fu">glue</span>(<span class="st">"Beyond Notability has recorded little information about {personLabel}."</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(statement, person) <span class="sc">|&gt;</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add a column for ordering statements in the final output</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">order=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="middle-and-endings" class="level3">
<h3 class="anchored" data-anchor-id="middle-and-endings">… middle and endings</h3>
<p>Subsequent sentences should begin with “She” rather than repeating the names every time, so this is the final version of the academic degrees statements.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>bn_degrees_statements <span class="ot">&lt;-</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>degrees_query <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the augmented labels </span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(hei <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">by=</span>item, the_label), <span class="at">by=</span><span class="st">"by"</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use the_label instead of the original</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">glue_by =</span> <span class="fu">prefix_na</span>(the_label, <span class="st">"by"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">glue_year =</span> <span class="fu">prefix_na</span>(year, <span class="st">"in"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">glue_degree =</span> <span class="fu">glue</span>(<span class="st">"a {degreeLabel}{glue_by}{glue_year}"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(personLabel, person) <span class="sc">|&gt;</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">degree_collapse =</span> </span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>              <span class="fu">glue_collapse</span>(glue_degree, <span class="st">", "</span>, <span class="at">last =</span> <span class="st">" and "</span>), <span class="at">.groups =</span> <span class="st">"drop_last"</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">statement=</span> <span class="fu">glue</span>(<span class="st">"She was awarded {degree_collapse}."</span>)) <span class="sc">|&gt;</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(statement, person) <span class="sc">|&gt;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">order=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A final sentence for date of death, where we have it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>bn_death_statements <span class="ot">&lt;-</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>bn_dates_main_query <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date_prop<span class="sc">==</span><span class="st">"P15"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(person, year) <span class="sc">|&gt;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(person) <span class="sc">|&gt;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">1</span>, year) <span class="sc">|&gt;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">statement =</span> <span class="fu">glue</span>(<span class="st">"She died in {year}."</span>) ) <span class="sc">|&gt;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(statement, person) <span class="sc">|&gt;</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">order=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="bringing-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="bringing-it-all-together">Bringing it all together</h2>
<p>The <code>bind_rows()</code> function combines all the separate statements into a single long dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>bn_bind_statements <span class="ot">&lt;-</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  bn_first_sentence, </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  bn_degrees_statements,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  bn_death_statements</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(person) <span class="sc">|&gt;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ensure statements come out in the order you want them....</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(order, <span class="at">.by_group =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">statements =</span> <span class="fu">glue_collapse</span>(statement, <span class="at">sep=</span><span class="st">" "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># right now I only want the five women in the sample!</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(bn_degrees_statements, <span class="at">by=</span><span class="st">"person"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-final-output" class="level2">
<h2 class="anchored" data-anchor-id="the-final-output">The final output</h2>
<p>I’ll use glue_data() at the very end of the pipeline. The “results=‘asis’” option in the R code chunk ensures that Markdown formatting inside any of the glue statements gets rendered when the code is knitted.</p>
<p>The very last step will be to use rmarkdown::render() to “knit” the output to another file (which could be PDF, DOCX or markdown or something else).</p>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>bn_heading <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(bn_degrees_statements, <span class="at">by=</span><span class="st">"person"</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    bn_bind_statements, <span class="at">by=</span><span class="st">"person"</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># with markdown H2 heading and line breaks</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glue_data</span>(<span class="st">"## {name_id_statements}</span><span class="sc">\n\n</span><span class="st">{statements}</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="annie-abram-q536-56-statements" class="level2">
<h2 class="anchored" data-anchor-id="annie-abram-q536-56-statements">Annie Abram (Q536: 56 statements)</h2>
<p>Annie Abram was born in 1869. She was awarded a bachelor’s degree by Trinity College Dublin in 1906 and a doctor of science by the University of London in 1909. She died in 1930.</p>
</section>
<section id="irene-josephine-churchill-q317-34-statements" class="level2">
<h2 class="anchored" data-anchor-id="irene-josephine-churchill-q317-34-statements">Irene Josephine Churchill (Q317: 34 statements)</h2>
<p>Irene Josephine Churchill was born in 1887. She was awarded a doctor of philosophy by the University of Oxford in 1930. She died in 1961.</p>
</section>
<section id="agnes-conway-horsfield-q916-60-statements" class="level2">
<h2 class="anchored" data-anchor-id="agnes-conway-horsfield-q916-60-statements">Agnes Conway Horsfield (Q916: 60 statements)</h2>
<p>Agnes Conway Horsfield was born in 1885. She was awarded a bachelor’s degree by Trinity College Dublin in 1907 and a master’s degree by the University of London in 1926. She died in 1950.</p>
</section>
<section id="kathleen-mary-kenyon-q709-80-statements" class="level2">
<h2 class="anchored" data-anchor-id="kathleen-mary-kenyon-q709-80-statements">Kathleen Mary Kenyon (Q709: 80 statements)</h2>
<p>Kathleen Mary Kenyon was born in 1906. She was awarded a bachelor’s degree by the University of Oxford in 1928, a master’s degree by the University of Oxford in 1933 and a Doctor of Letters by the University of London in 1954. She died in 1978.</p>
</section>
<section id="margaret-e.-c.-stewart-q3989-19-statements" class="level2">
<h2 class="anchored" data-anchor-id="margaret-e.-c.-stewart-q3989-19-statements">Margaret E. C. Stewart (Q3989: 19 statements)</h2>
<p>Margaret E. C. Stewart was born in 1907. She was awarded a master’s degree by the University of Edinburgh and a doctor of philosophy by the University of Edinburgh. She died in 1986.</p>
</section>
<section id="full-code-and-sample-outputs" class="level2">
<h2 class="anchored" data-anchor-id="full-code-and-sample-outputs">Full code and sample outputs</h2>
<p>See <a href="https://github.com/Beyond-Notability/bn_r_doc">the BN R Documentation repository</a>.</p>
</section>
<section id="see-also" class="level2">
<h2 class="anchored" data-anchor-id="see-also">See also</h2>
<ul>
<li><a href="https://ericrscott.com/posts/2023-08-08-google-forms-quarto/">Re-constructing Google Forms responses with Quarto and {glue}</a></li>
<li><a href="https://www.njtierney.com/post/2019/07/07/glue-magic-p1/">Glue magic</a></li>
<li><a href="https://glue.tidyverse.org/">{glue} documentation</a></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/beyond-notability\.github\.io\/bn_notes\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>